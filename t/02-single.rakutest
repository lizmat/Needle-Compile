BEGIN %*ENV<RAKU_TEST_DIE_ON_FAIL> = 1;

use Test;
use Needle::Compile;

plan 7;

code ".subst('foo', 'bar')", "foo", "bar", 'simple .subst';
code ".uc",                  "foo", "FOO", 'simple .uc';

run-nameds &contains, "foo", "foo", "bar", "find simple 'foo'";

run-nameds &starts-with, "foo", "foo", "bar", "starts with simple 'foo'";

run-nameds &ends-with, "foo", "foo", "bar", "ends with simple 'foo'";

run-nameds &equal, "foo", "foo", "bar", "equal simple 'foo'";

run-nameds &words, "foo", "foo", "bar", "words simple 'foo'";

#-------------------------------------------------------------------------------
# Infrastructure

# Adding a .type method to an object
my role Type {
    has $.type;
    method raku() { callsame() ~ " but Type('$!type')" }
}

# Filter out the targets that are pure strings
my sub autonots(@targets) {
    @targets.map: { "!$_" if .WHAT =:= Str }
}

# Run the given needle specification for all possible named arguments
my @nameds = (), :ignorecase, :ignoremark, :smartcase, :smartmark;
my sub run-nameds(&code, |c) is test-assertion {
    subtest "all named arguments for &code.name()" => {
        plan +@nameds;
        code |c, |$_ for @nameds;
    }
}

#- code ------------------------------------------------------------------------
# All tests for code that aren't tested elsewhere
my sub code($target, $source, $result, $comment) is test-assertion {
    subtest "code: $comment" => {
        my @targets =
          $target but Type("code"),
          "\{$target}",
          code => $target,
        ;
        @targets.push("*$target") if $target.starts-with(".");

        plan 2 * @targets;

        for @targets {
            my $needle := compile-needle($_);
            isa-ok $needle, Callable, "Testing $_.raku()";

            is-deeply $needle($source), $result, "'$source' transformed ok";
        }
    }
}

#- contains --------------------------------------------------------------------
# All possible tests for contains
my sub contains($target, $hit, $miss, $comment, *%_) is test-assertion {
    my $named := %_ ?? ", :%_.keys.head()" !! "";

    subtest "contains: $comment$named$named" => {
        my $ascode := ".contains('$target')";

        my @targets =
          $target,
          $target but Type("auto"),
          $target but Type("contains"),
          $target but Type("regex"),
          $ascode but Type("code"),
          "/$target/",
          "\{$ascode}",
          "*$ascode",
          auto     => $target,
          contains => $target,
          regex    => $target,
          code     => $ascode,
        ;

        my @autonots = autonots @targets;

        plan 8 * @targets + 4 * @autonots;

        for @targets {
            my $needle := compile-needle($_, |%_);
            isa-ok $needle, Callable, "Testing $_.raku()";

            is-deeply $needle($hit),          True,  "hit '$hit'";
            is-deeply $needle("in{$hit}out"), True,  "hit 'in{$hit}out'";
            is-deeply $needle($miss),         False, "miss '$miss'";

            my $not := compile-needle( (not => $_,) );
            isa-ok $not, Callable, "Testing not $_.raku()";

            is-deeply $not($hit),          False, "not hit '$hit'";
            is-deeply $not("in{$hit}out"), False, "not hit 'in{$hit}out'";
            is-deeply $not($miss),         True,  "not miss '$miss'";
        }

        for @autonots {
            my $not := compile-needle($_, |%_);
            isa-ok $not, Callable, "Testing '$_'";

            is-deeply $not($hit),          False, "! hit '$hit'";
            is-deeply $not("in{$hit}out"), False, "! hit 'in{$hit}out'";
            is-deeply $not($miss),         True,  "! miss '$miss'";
        }
    }
}

#- starts-with -----------------------------------------------------------------
# All possible tests for starts-with
my sub starts-with($target, $hit, $miss, $comment, *%_) is test-assertion {
    my $named := %_ ?? ", :%_.keys.head()" !! "";

    subtest "starts-with: $comment$named" => {
        my $auto   := "^$target";
        my $ascode := ".starts-with('$target')";

        my @targets =
          $target but Type("starts-with"),
          $auto,
          $auto   but Type("auto"),
          $auto   but Type("regex"),
          $ascode but Type("code"),
          "/^ $target/",
          "\{$ascode}",
          "*$ascode",
          starts-with => $target,
          auto        => $auto,
          regex       => $auto,
          code        => $ascode,
        ;

        my @autonots = autonots @targets;

        plan 8 * @targets + 4 * @autonots;

        for @targets {
            my $needle := compile-needle($_, |%_);
            isa-ok $needle, Callable, "Testing $_.raku()";

            is-deeply $needle($hit),    True,  "hit '$hit'";
            is-deeply $needle(" $hit"), False, "miss ' $hit'";
            is-deeply $needle($miss),   False, "miss '$miss'";

            my $not := compile-needle( (not => $_,) );
            isa-ok $not, Callable, "Testing not $_.raku()";

            is-deeply $not($hit),    False, "not hit '$hit'";
            is-deeply $not(" $hit"), True,  "not miss ' $hit'";
            is-deeply $not($miss),   True,  "not miss '$miss'";
        }

        for @autonots {
            my $not := compile-needle($_, |%_);
            isa-ok $not, Callable, "Testing !$_";

            is-deeply $not($hit),    False, "! hit '$hit'";
            is-deeply $not(" $hit"), True,  "! miss ' $hit'";
            is-deeply $not($miss),   True,  "! miss '$miss'";
        }
    }
}

#- ends-with -------------------------------------------------------------------
# All possible tests for ends-with
my sub ends-with($target, $hit, $miss, $comment, *%_) is test-assertion {
    my $named := %_ ?? ", :%_.keys.head()" !! "";

    subtest "ends-with: $comment$named" => {
        my $auto   := $target ~ '$';
        my $ascode := ".ends-with('$target')";

        my @targets =
          $target but Type("ends-with"),
          $auto,
          $auto   but Type("auto"),
          $auto   but Type("regex"),
          $ascode but Type("code"),
          "/$target \$/",
          "\{$ascode}",
          "*$ascode",
          ends-with => $target,
          auto      => $auto,
          code      => $ascode,
          regex     => $auto,
        ;

        my @autonots = autonots @targets;

        plan 8 * @targets + 4 * @autonots;

        for @targets {
            my $needle := compile-needle($_, |%_);
            isa-ok $needle, Callable, "Testing $_.raku()";

            is-deeply $needle($hit),    True,  "hit '$hit'";
            is-deeply $needle("$hit "), False, "miss '$hit '";
            is-deeply $needle($miss),   False, "miss '$miss'";

            my $not := compile-needle( (not => $_,) );
            isa-ok $not, Callable, "Testing not $_.raku()";

            is-deeply $not($hit),    False, "not hit '$hit'";
            is-deeply $not("$hit "), True,  "not miss '$hit '";
            is-deeply $not($miss),   True,  "not miss '$miss'";
        }

        for @autonots {
            my $not := compile-needle($_, |%_);
            isa-ok $not, Callable, "Testing !$_";

            is-deeply $not($hit),    False, "! hit '$hit'";
            is-deeply $not("$hit "), True,  "! miss '$hit '";
            is-deeply $not($miss),   True,  "! miss '$miss'";
        }
    }
}

#- equal -----------------------------------------------------------------------
# All possible tests for equal
my sub equal($target, $hit, $miss, $comment, *%_) is test-assertion {
    my $named := %_ ?? ", :%_.keys.head()" !! "";

    subtest "equal: $comment$named" => {
        my $auto   := "^$target\$";
        my $ascode := "'$target' eq \$_";

        my @targets =
          $target but Type("equal"),
          $auto,
          $auto   but Type("auto"),
          $ascode but Type("code"),
          "/^ $target \$/",
          "\{$ascode}",
          auto  => $auto,
          regex => $auto,
          code  => $ascode,
        ;

        my @autonots = autonots @targets;

        plan 8 * @targets + 4 * @autonots;

        for @targets {
            my $needle := compile-needle($_, |%_);
            isa-ok $needle, Callable, "Testing $_.raku()";

            is-deeply $needle($hit),     True,  "hit '$hit'";
            is-deeply $needle(" $hit "), False, "miss ' $hit '";
            is-deeply $needle($miss),    False, "miss '$miss'";

            my $not := compile-needle( (not => $_,) );
            isa-ok $not, Callable, "Testing not $_.raku()";

            is-deeply $not($hit),     False, "not hit '$hit'";
            is-deeply $not(" $hit "), True,  "not miss ' $hit '";
            is-deeply $not($miss),    True,  "not miss '$miss'";
        }

        for @autonots {
            my $not := compile-needle($_, |%_);
            isa-ok $not, Callable, "Testing !$_";

            is-deeply $not($hit),     False, "! hit '$hit'";
            is-deeply $not(" $hit "), True,  "! miss ' $hit '";
            is-deeply $not($miss),    True,  "! miss '$miss'";
        }
    }
}

#- words -----------------------------------------------------------------------
# All possible tests for words
my sub words($target, $hit, $miss, $comment, *%_) is test-assertion {
    my $named := %_ ?? ", :%_.keys.head()" !! "";

    subtest "words: $comment$named" => {
        my $auto := "ยง$target";

        my @targets =
          $target but Type("words"),
          $auto,
          $auto   but Type("auto"),
          words => $target,
          auto  => $auto,
        ;

        my @autonots = autonots @targets;

        plan 12 * @targets + 6 * @autonots;

        for @targets {
            my $needle := compile-needle($_, |%_);
            isa-ok $needle, Callable, "Testing $_.raku()";

            is-deeply $needle($hit),         True,  "hit '$hit'";
            is-deeply $needle(" $hit "),     True,  "hit ' $hit '";
            is-deeply $needle(":$hit:"),     True,  "hit ':$hit:'";
            is-deeply $needle("oo{$hit}ff"), False, "miss 'oo{$hit}ff'";
            is-deeply $needle($miss),        False, "miss '$miss'";

            my $not := compile-needle( (not => $_,), |%_ );
            isa-ok $not, Callable, "Testing not $_.raku()";

            is-deeply $not($hit),         False, "not hit '$hit'";
            is-deeply $not(" $hit "),     False, "not hit ' $hit '";
            is-deeply $not(":$hit:"),     False, "not hit ':$hit:'";
            is-deeply $not("oo{$hit}ff"), True,  "not miss 'oo{$hit}ff'";
            is-deeply $not($miss),        True,  "not miss '$miss'";
        }

        for @autonots {
            my $not := compile-needle($_, |%_);
            isa-ok $not, Callable, "Testing !$_";

            is-deeply $not($hit),         False, "! hit '$hit'";
            is-deeply $not(" $hit "),     False, "! hit ' $hit '";
            is-deeply $not(":$hit:"),     False, "! hit ':$hit:'";
            is-deeply $not("oo{$hit}ff"), True,  "! miss 'oo{$hit}ff'";
            is-deeply $not($miss),        True,  "! miss '$miss'";
        }
    }
}

# vim: expandtab shiftwidth=4
